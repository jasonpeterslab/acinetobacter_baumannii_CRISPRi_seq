---
title: "Bins of Significance"
keep_md: no
author: "Ryan Ward"
date: '2022-05-04'
output: html_document
---
```{r overlap calculations}
library(pacman)

p_load(eulerr, data.table, viridis, grid, ComplexHeatmap, tidyverse, ComplexUpset)

interest <- fread("../../interest.tsv", sep = "\t")

median_melted_results <- fread("../../Results/median_melted_results.tsv.gz")

bins <- 
	median_melted_results[
		, .(significant = FDR < 0.01 & medLFC < 0), 
		by = .(condition, unique_name, type)]

bins <- bins[condition %in% c("None_0_T1 - None_0_T0", "None_0_T2 - None_0_T0")]

bins <-
	dcast(bins, unique_name + type ~ condition, value.var = "significant")

bins[`None_0_T1 - None_0_T0` == FALSE & `None_0_T2 - None_0_T0` == FALSE, `Never Vulnerable` := TRUE]
bins[is.na(`Never Vulnerable`), `Never Vulnerable` := FALSE]
```
```{r venn diagram, fig.width=8, fig.height=8}

p.euler <- bins[type == "perfect"] %>% select (-c(unique_name, type)) %>% euler

p <- plot(
	p.euler,
	fill = viridis(3, option = "cividis", direction = -1, alpha = 0.25), 
	quantities = T,
	lwd = 0.5)

oldGrob <- getGrob(p, "tag.label.1")
newGrob <- editGrob(oldGrob, label = bquote(Vulnerable~by~t[1]))
p <- setGrob(p, "tag.label.1", newGrob)

oldGrob <- getGrob(p, "tag.label.2")
newGrob <- editGrob(oldGrob, label = bquote(Vulnerable~between~t[1]~and~t[2]))
p <- setGrob(p, "tag.label.2", newGrob)

oldGrob <- getGrob(p, "tag.label.3")
newGrob <- editGrob(oldGrob, label = bquote(Not~vulnerable))
p <- setGrob(p, "tag.label.3", newGrob)

print(p)
```

```{r Cell Wall activity in Meropenem, fig.width=6, fig.height=4}
vulnerability.comb_mat <- 
	median_melted_results %>% 
    filter(type == "perfect") %>%
    mutate(depleted = (FDR < 0.01 & medLFC < 0)) %>%  
    pivot_wider(
    	id_cols = unique_name, 
    	names_from = condition, values_from = depleted) %>% 
	select(`None_0_T1 - None_0_T0`, `None_0_T2 - None_0_T0`) %>% 
	make_comb_mat() 

UpSet(
	vulnerability.comb_mat, 
	top_annotation = HeatmapAnnotation(
		"Intersection" = anno_barplot(
			comb_size(vulnerability.comb_mat),
			border = FALSE, 
			height = unit(6, "cm"),
			add_numbers = T,
			gp = gpar(fill = "grey", lty = "blank")), 
		annotation_name_side = "right", 
		annotation_name_rot = 90,
		show_annotation_name = FALSE),
	right_annotation = rowAnnotation(
		"Genes Vulnerable Upon Induction" = anno_barplot(
			set_size(vulnerability.comb_mat),
			border = FALSE,
			gp = gpar(fill =  viridis(3, direction = -1, alpha = 0.5)[2:3], lwd = 3),
			width = unit(7, "cm"),
			add_numbers = T),
			annotation_name_gp = gpar(fontsize = 8)),
	set_order = order(set_size(vulnerability.comb_mat)),
	row_names_gp = grid::gpar(fontsize = 10),
	row_labels = c(
		as.expression(bquote(Vulnerable~at~t[1])), 
		as.expression(bquote(Vulnerable~at~t[2]))))
```