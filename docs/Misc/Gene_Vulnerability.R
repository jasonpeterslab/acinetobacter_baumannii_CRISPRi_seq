library(pacman)

interested.genes <- c("mraY", "murC", "murG", "lpxC", "nuoB")

interested.conditions <- c(
	"None_0_T1 - None_0_T0", 
	"Colistin_0.44_T1 - None_0_T0", 
	"Rifampicin_0.34_T1 - None_0_T0",
	"Meropenem_0.11_T1 - None_0_T0", 
	"Meropenem_0.17_T1 - None_0_T0")


# interested.conditions <- c("None_0_T1 - None_0_T0", "Meropenem_0.11_T1 - None_0_T0", "Meropenem_0.17_T1 - None_0_T0")

p_load(data.table, drc, tidyverse, broom, conflicted, modelr)

conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")

melted_results <- fread("../../Results/melted_results.tsv.gz", sep = "\t")
interest <- fread("../../interest.tsv", sep = "\t")

# melted_results <- melted_results[condition %in% interest$condition]

melted_results <- tibble(melted_results)

drm.parameters <- c("hill", "min_value", "max_value", "ec_50")

lower_range <- min(melted_results$y_pred, na.rm = T)
upper_range <- max(melted_results$y_pred, na.rm = T)

prediction_range <- 
	expand.grid(
		y_pred = seq(lower_range, upper_range, length = 250))

drm.try <- 
	suppressWarnings(possibly(drm, otherwise = NA))

augment.try <- 
	suppressWarnings(possibly(augment, otherwise = NA))

mismatches <-
	melted_results %>%
	dplyr::filter(type == "mismatch") %>%
 	nest(data = c(-condition, -unique_name))

mismatches <- 
	mismatches %>% mutate(upper = map_dbl(data, ~ max(.$y_pred)))

conflict_prefer("filter", "stats")

mismatches <- 
	mismatches %>% 
	dplyr::filter(unique_name %in% interested.genes) %>%
	dplyr::filter(condition %in% interested.conditions) %>%
	mutate(fit = map(data, ~ drm.try(data = ., LFC.adj ~ y_pred, fct = L.4(names = drm.parameters)))) %>% 
	mutate(results = map(fit, glance)) %>%
	mutate(condition = factor(condition, levels = interested.conditions))

mismatches <- 
	mismatches %>% 
	mutate(predictions = map2(
		fit,
		data, 
		~ augment.try(
			.x, 
			newdata = expand.grid(y_pred = seq(min(.y$y_pred), max(.y$y_pred), length = 250)),
			conf.int = T,
			conf.level = 0.90)))

conflict_prefer("filter", "dplyr")

fit_predictions <- mismatches %>% 
	select(unique_name, condition, predictions) %>% 
	unnest(predictions)

fit_points <- mismatches %>% 
	select(unique_name, condition, data) %>% 
	unnest(data)

##########################################################################################

plot_graphic <-
	fit_predictions %>% 
	filter(unique_name %in% c("mraY", "murC", "murG") & 
				 	condition == "Meropenem_0.17_T1 - None_0_T0") %>%
		ggplot() +
	geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 0.5) +
			geom_line(
			alpha = 1, size = 2, 
			aes(x = y_pred, y = .fitted, color = unique_name)) +
	geom_point(
			data = fit_points %>% 
				filter(unique_name %in% c("mraY", "murC", "murG") & 
							 	condition == "Meropenem_0.17_T1 - None_0_T0"),
			shape = 20, size = 5,
			aes(x = y_pred, y = LFC.adj, color = unique_name)) + 
	geom_ribbon(
		data = fit_predictions %>% 
			filter(unique_name %in% c("mraY", "murC", "murG") & 
						 	condition == "Meropenem_0.17_T1 - None_0_T0"),
		alpha = 0.30,
		aes(x = y_pred, y = .fitted, ymin = .lower, ymax = .upper, fill = unique_name)) +
	scale_fill_viridis(discrete = TRUE, direction = -1) +
	scale_color_viridis(discrete = TRUE, direction = -1) +
	ggtitle("Cell Wall Vulnerability (Meropenem + Induction at t[1]). CI = 90%.") +
	xlab("Predicted Knockdown") +
	ylab("Log-2 Fitness Foldchange") +
	labs(fill = "Gene", color = "Gene") +
	xlim(0, mismatches %>% unnest(data) %>% select(y_pred) %>% max()) +
	coord_cartesian(ylim = c(
		mismatches %>% unnest(data) %>% select(LFC.adj) %>% min(), 
		mismatches %>% unnest(data) %>% select(LFC.adj) %>% max())) +
	theme_ipsum() +
	theme(legend.position = "bottom") 

print(plot_graphic)

##########################################################################################


plot_graphic <-
	fit_predictions %>% 
	filter(unique_name %in% c("nuoB") & 
				 	condition %in% c("None_0_T1 - None_0_T0", "Colistin_0.44_T1 - None_0_T0", "Rifampicin_0.34_T1 - None_0_T0")) %>%
	ggplot() +
	geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 0.5) +
	geom_line(
		alpha = 1, size = 2, 
		aes(x = y_pred, y = .fitted, color = condition)) +
	geom_point(
		data = fit_points %>% 
			filter(unique_name %in% c("nuoB") & 
						 	condition %in% c("None_0_T1 - None_0_T0", "Colistin_0.44_T1 - None_0_T0", "Rifampicin_0.34_T1 - None_0_T0")),
			shape = 20, size = 5,
		aes(x = y_pred, y = LFC.adj, color = condition)) + 
	geom_ribbon(
		data = fit_predictions %>% 
			filter(unique_name %in% c("nuoB") & 
						 	condition %in% c("None_0_T1 - None_0_T0", "Colistin_0.44_T1 - None_0_T0", "Rifampicin_0.34_T1 - None_0_T0")),
			alpha = 0.30,
		aes(x = y_pred, y = .fitted, ymin = .lower, ymax = .upper, fill = condition)) +
	scale_fill_viridis(discrete = TRUE, direction = -1) +
	scale_color_viridis(discrete = TRUE, direction = -1) +
	ggtitle("nuoB Vulnerability at t[1]. CI = 90%.") +
	xlab("Predicted Knockdown") +
	ylab("Log-2 Fitness Foldchange") +
	labs(fill = "Condition", color = "Condition") +
	xlim(0, mismatches %>% unnest(data) %>% select(y_pred) %>% max()) +
	coord_cartesian(ylim = c(
		mismatches %>% unnest(data) %>% select(LFC.adj) %>% min(), 
		mismatches %>% unnest(data) %>% select(LFC.adj) %>% max())) +
	theme_ipsum() +
	theme(legend.position = "bottom") 

print(plot_graphic)

##########################################################################################


plot_graphic <-
	fit_predictions %>% 
	filter(unique_name %in% c("lpxC") & 
				 	condition %in% c("None_0_T1 - None_0_T0", "Colistin_0.44_T1 - None_0_T0", "Rifampicin_0.34_T1 - None_0_T0")) %>%
	ggplot() +
	geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 0.5) +
	geom_line(
		alpha = 1, size = 2, 
		aes(x = y_pred, y = .fitted, color = condition)) +
	geom_point(
		data = fit_points %>% 
			filter(unique_name %in% c("lpxC") & 
						 	condition %in% c("None_0_T1 - None_0_T0", "Colistin_0.44_T1 - None_0_T0", "Rifampicin_0.34_T1 - None_0_T0")),
		shape = 20, size = 5,
		aes(x = y_pred, y = LFC.adj, color = condition)) + 
	geom_ribbon(
		data = fit_predictions %>% 
			filter(unique_name %in% c("lpxC") & 
						 	condition %in% c("None_0_T1 - None_0_T0", "Colistin_0.44_T1 - None_0_T0", "Rifampicin_0.34_T1 - None_0_T0")),
		alpha = 0.30,
		aes(x = y_pred, y = .fitted, ymin = .lower, ymax = .upper, fill = condition)) +
	scale_fill_viridis(discrete = TRUE, direction = -1) +
	scale_color_viridis(discrete = TRUE, direction = -1) +
	ggtitle("lpxC Vulnerability at t[1]. CI = 90%.") +
	xlab("Predicted Knockdown") +
	ylab("Log-2 Fitness Foldchange") +
	labs(fill = "Condition", color = "Condition") +
	xlim(0, mismatches %>% unnest(data) %>% select(y_pred) %>% max()) +
	coord_cartesian(ylim = c(
		mismatches %>% unnest(data) %>% select(LFC.adj) %>% min(), 
		mismatches %>% unnest(data) %>% select(LFC.adj) %>% max())) +
	theme_ipsum() +
	theme(legend.position = "bottom") 

print(plot_graphic)


